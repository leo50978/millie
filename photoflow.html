<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Galerie Photo Immersive</title>
    
    <!-- CDN Imports -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    
    <style>
        .scroll-container {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        .scroll-container::-webkit-scrollbar {
            display: none;
        }
        
        .snap-scroll {
            scroll-snap-type: y mandatory;
            scroll-behavior: smooth;
        }
        
        .snap-section {
            scroll-snap-align: start;
            scroll-snap-stop: always;
        }
        
        .fade-in {
            animation: fadeIn 0.8s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .like-pulse {
            animation: heartPulse 0.6s ease-in-out;
        }
        
        @keyframes heartPulse {
            0% { transform: scale(1); }
            25% { transform: scale(1.3); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .image-container {
            background: linear-gradient(45deg, #1a202c, #2d3748);
            position: relative;
        }

        .image-placeholder {
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, #2d3748, #4a5568);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Styles pour l'écran de chargement */
        #loadingScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a202c 0%, #2d3748 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.8s ease-out, visibility 0.8s ease-out;
        }

        #loadingScreen.fade-out {
            opacity: 0;
            visibility: hidden;
        }

        .loader {
            width: 60px;
            height: 60px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border-top-color: #60a5fa;
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .liked {
            background-color: #dc2626 !important;
        }
        
        .like-btn.liked:hover {
            background-color: #b91c1c !important;
        }
    </style>
</head>
<body class="bg-gray-900 text-white font-['Inter'] h-screen overflow-hidden">
    
    <!-- Écran de chargement -->
    <div id="loadingScreen">
        <div class="logo text-2xl font-bold mb-4">PHOTOFLOW</div>
        <div class="loader"></div>
        <div class="loader-text text-white text-lg">Chargement de la galerie...</div>
    </div>

    <!-- Éléments audio cachés -->
    <audio id="scrollSound" preload="auto">
        <source src="scrollsound.mp3" type="audio/wav">
    </audio>
    <audio id="likeSound" preload="auto">
        <source src="likebouton.mp3" type="audio/wav">
    </audio>
    <audio id="shareSound" preload="auto">
        <source src="bouton.mp3" type="audio/wav">
    </audio>

    <!-- Contenu principal -->
    <main class="h-full overflow-y-auto snap-scroll scroll-container" id="mainContainer" style="opacity: 0;">
        <!-- Les sections photos seront générées dynamiquement ici -->
    </main>

    <!-- Icône de classement fixe -->
    <button id="rankingIcon" class="fixed top-6 right-6 bg-yellow-500 hover:bg-yellow-600 w-14 h-14 rounded-full flex items-center justify-center shadow-2xl transition-all duration-300 z-50 transform hover:scale-110">
        <i class="fas fa-trophy text-white text-2xl"></i>
    </button>

    <!-- Modal de classement -->
    <div id="rankingModal" class="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 hidden p-4 transition-opacity duration-300 ease-out overflow-y-auto">
        <div class="relative bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 rounded-3xl shadow-2xl p-6 sm:p-8 w-full max-w-sm sm:max-w-md mx-auto border border-gray-700/50 my-10 max-h-[90vh] overflow-y-auto scrollbar-thin scrollbar-thumb-gray-700 scrollbar-track-transparent">
            <!-- Header -->
            <div class="sticky top-0 bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 z-10 flex justify-between items-center mb-6 border-b border-gray-700/40 pb-3">
                <h2 class="text-xl sm:text-2xl font-bold flex items-center text-white">
                    <i class="fas fa-trophy text-yellow-400 mr-2 sm:mr-3"></i>
                    Classement Général
                </h2>
                <button id="closeModal" class="text-gray-400 hover:text-white transition-colors duration-200 text-lg sm:text-xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <!-- Ranking List -->
            <div id="rankingList" class="space-y-4 mb-6">
                <!-- Le contenu sera généré dynamiquement -->
            </div>
            
            <!-- Close Button -->
            <button id="closeModalBtn" class="sticky bottom-0 w-full bg-gradient-to-r from-gray-700 to-gray-600 hover:from-gray-600 hover:to-gray-500 py-3 sm:py-3.5 rounded-xl font-semibold text-white shadow-lg transition-all duration-200 hover:shadow-xl">
                Fermer
            </button>
        </div>
    </div>

    <script>
        // =============================================
        // CONFIGURATION
        // =============================================

        const firebaseConfig = {
            apiKey: "AIzaSyANd0tZl-6P6l84ab-FSRIX9ISPd_YCe6I",
            authDomain: "cpieo-99bd5.firebaseapp.com",
            projectId: "cpieo-99bd5",
            storageBucket: "cpieo-99bd5.firebasestorage.app",
            messagingSenderId: "405125968337",
            appId: "1:405125968337:web:7d5f74b710cc23b84270f0"
        };

        // Photos initiales avec données par défaut
       
               const photos = [
            {
                id: 1,
                url: "image1.jpg",
                name: "Sarah M.",
                theme: "Nature",
                likes: 0,
                liked: false
            },
            {
                id: 2,
                url: "image2.jpg",
                name: "Karim B.",
                theme: "Paysage",
                likes: 0,
                liked: false
            },
            {
                id: 3,
                url: "image3.jpg",
                name: "junior509.",
                theme: "Portrait",
                likes: 0,
                liked: false
            },
            {
                id: 4,
                url: "image4.jpg",
                name: "Leon P.",
                theme: "Portrait",
                likes: 0,
                liked: false
            },
            {
                id: 5,
                url: "image5.jpg",
                name: "Chris T.",
                theme: "Portrait",
                likes: 0,
                liked: false
            },
            {
                id: 6,
                url: "image6.jpg",
                name: "Marco Z.",
                theme: "Portrait",
                likes: 0,
                liked: false
            },
            {
                id: 7,
                url: "image7.jpg",
                name: "Gracieuse W.",
                theme: "Portrait",
                likes: 0,
                liked: false
            },
            {
                id: 8,
                url: "image8.jpg",
                name: "Gilbert T..",
                theme: "Portrait",
                likes: 0,
                liked: false
            },
            {
                id: 9,
                url: "image9.jpg",
                name: "Patrick K.",
                theme: "Portrait",
                likes: 0,
                liked: false
            },
            {
                id: 10,
                url: "image10.jpg",
                name: "Mimose B.",
                theme: "Portrait",
                likes: 0,
                liked: false
            },{
                id: 11,
                url: "image11.jpg",
                name: "Ketler N",
                theme: "Nature",
                likes: 0,
                liked: false
            },
            {
                id: 12,
                url: "image12.jpg",
                name: "Stacy J",
                theme: "Paysage",
                likes: 0,
                liked: false
            },
            {
                id: 13,
                url: "image13.jpg",
                name: "Jules R.",
                theme: "Portrait",
                likes: 675,
                liked: false
            },
            {
                id: 14,
                url: "image14.jpg",
                name: "Miriame R.",
                theme: "Portrait",
                likes: 0,
                liked: false
            },
            {
                id: 15,
                url: "image15.jpg",
                name: "MiMi J.",
                theme: "Portrait",
                likes: 0,
                liked: false
            },
            {
                id: 16,
                url: "image16.jpg",
                name: "Vladimir T.",
                theme: "Portrait",
                likes: 0,
                liked: false
            },
            {
                id: 17,
                url: "image17.jpg",
                name: "Julmis D.",
                theme: "Portrait",
                likes: 0,
                liked: false
            },
            {
                id: 18,
                url: "image18.jpg",
                name: "Patrick D.",
                theme: "Portrait",
                likes: 0,
                liked: false
            },
            {
                id: 19,
                url: "image19.jpg",
                name: "Vlemard D.",
                theme: "Portrait",
                likes: 0,
                liked: false
            },
            {
                id: 20,
                url: "image20.jpg",
                name: "Louis Y.",
                theme: "Portrait",
                likes: 0,
                liked: false
            },
             {
                id: 21,
                url: "image21.jpg",
                name: "Nelson T",
                theme: "Nature",
                likes: 0,
                liked: false
            },
            {
                id: 22,
                url: "image22.jpg",
                name: "Samsom V",
                theme: "Paysage",
                likes: 0,
                liked: false
            },
            {
                id: 23,
                url: "image23.jpg",
                name: "Louis Y.",
                theme: "Portrait",
                likes: 0,
                liked: false
            },
            {
                id: 24,
                url: "image24.jpg",
                name: "Chris R.",
                theme: "Portrait",
                likes: 0,
                liked: false
            },
            {
                id: 25,
                url: "image25.jpg",
                name: "Viviane T.",
                theme: "Portrait",
                likes: 0,
                liked: false
            },
            {
                id: 26,
                url: "image26.jpg",
                name: "Milien L.",
                theme: "Portrait",
                likes: 0,
                liked: false
            },
            {
                id: 27,
                url: "image27.jpg",
                name: "Varane U.",
                theme: "Portrait",
                likes: 0,
                liked: false
            },
            {
                id: 28,
                url: "image28.jpg",
                name: "Potland J.",
                theme: "Portrait",
                likes: 0,
                liked: false
            },
            {
                id: 29,
                url: "image29.jpg",
                name: "Joane J.",
                theme: "Portrait",
                likes: 0,
                liked: false
            },
            {
                id: 30,
                url: "image30.jpg",
                name: "Biana B.",
                theme: "Portrait",
                likes: 0,
                liked: false
            },{
                id: 31,
                url: "image31.jpg",
                name: "Raviol L",
                theme: "Nature",
                likes: 0,
                liked: false
            },
            {
                id: 32,
                url: "image32.jpg",
                name: "Vales D",
                theme: "Paysage",
                likes: 0,
                liked: false
            },
            {
                id: 33,
                url: "image33.jpg",
                name: "Lila P.",
                theme: "Portrait",
                likes: 0,
                liked: false
            },
            {
                id: 34,
                url: "image34.jpg",
                name: "Belize Z.",
                theme: "Portrait",
                likes: 0,
                liked: false
            },
            {
                id: 35,
                url: "image35.jpg",
                name: "jemima J.",
                theme: "Portrait",
                likes: 0,
                liked: false
            },
            {
                id: 36,
                url: "image36.jpg",
                name: "Yvon Y.",
                theme: "Portrait",
                likes: 0,
                liked: false
            },
             {
                id: 41,
                url: "kervensphoto1.jpeg",
                name: "Kervens234.",
                theme: "food",
                likes:0,
                liked: false
            },
            {
                id: 42,
                url: "master1.jpeg",
                name: "Master Dave.",
                theme: "Nou vin pou champion ",
                likes:0,
                liked: false
            },
              {
                id: 43,
                url: "cadet1.jpeg",
                name: "Cadet Calendy.",
                theme: "Limyè a Se Mwen ",
                likes:0,
                liked: false
            },
            {
                id: 37,
                url: "image37.jpg",
                name: "Rejeane F.",
                theme: "Portrait",
                likes:0,
                liked: false
            },
            {
                id: 38,
                url: "image38.jpg",
                name: "Danielle T.",
                theme: "Portrait",
                likes:0,
                liked: false
            },
            {
                id: 39,
                url: "image39.jpg",
                name: "Beliz K.",
                theme: "Portrait",
                likes: 0,
                liked: false
            },
            {
                id: 40,
                url: "image40.jpg",
                name: "Leon P.",
                theme: "Portrait",
                likes: 0,
                liked: false
            }
        ];


        // =============================================
        // GESTIONNAIRE AUDIO SIMPLIFIÉ
        // =============================================

        class SimpleSoundManager {
            constructor() {
                this.sounds = {
                    scroll: document.getElementById('scrollSound'),
                    like: document.getElementById('likeSound'),
                    share: document.getElementById('shareSound')
                };
                this.initialized = false;
            }

            init() {
                if (this.initialized) return;
                
                Object.values(this.sounds).forEach(sound => {
                    sound.volume = 0.3;
                });
                
                this.sounds.like.volume = 0.6;
                this.initialized = true;
            }

            play(soundName) {
                if (!this.initialized || !this.sounds[soundName]) return;
                
                try {
                    const sound = this.sounds[soundName];
                    sound.currentTime = 0;
                    sound.play().catch(e => {
                        console.log('Audio non joué:', e);
                    });
                } catch (error) {
                    console.warn('Erreur son:', error);
                }
            }
        }

        // =============================================
        // GESTIONNAIRE DE CHARGEMENT
        // =============================================

        class LoadingManager {
            constructor() {
                this.loadingScreen = document.getElementById('loadingScreen');
                this.mainContainer = document.getElementById('mainContainer');
                this.targetPhotoId = null;
            }

            async startLoading() {
                this.targetPhotoId = this.getTargetPhotoIdFromURL();
                
                await this.initializeFirebase();
                await this.loadPhotosFromFirebase();
                this.renderPhotos();
                
                window.soundManager.init();
                
                setTimeout(() => {
                    this.completeLoading();
                }, 800);
            }

            getTargetPhotoIdFromURL() {
                const urlParams = new URLSearchParams(window.location.search);
                const photoId = urlParams.get('photo');
                return photoId ? parseInt(photoId) : null;
            }

            async initializeFirebase() {
                return new Promise((resolve) => {
                    try {
                        firebase.initializeApp(firebaseConfig);
                        resolve();
                    } catch (error) {
                        console.warn('Firebase:', error);
                        resolve();
                    }
                });
            }

            async loadPhotosFromFirebase() {
                try {
                    const db = firebase.firestore();
                    
                    for (let photo of photos) {
                        const docRef = db.collection('photos').doc(photo.id.toString());
                        const doc = await docRef.get();
                        
                        if (doc.exists) {
                            photo.likes = doc.data().totalLikes || 0;
                        } else {
                            await docRef.set({
                                url: photo.url,
                                name: photo.name,
                                theme: photo.theme,
                                totalLikes: photo.likes
                            });
                        }
                    }
                } catch (error) {
                    console.error('Erreur lors du chargement depuis Firebase:', error);
                }
            }

            renderPhotos() {
                const container = document.getElementById('mainContainer');
                
                container.innerHTML = photos.map(photo => `
                    <section class="h-screen w-full snap-section relative" id="photo-${photo.id}">
                        <div class="image-container w-full h-full">
                            <div class="image-placeholder">
                                <i class="fas fa-image text-5xl text-gray-600"></i>
                            </div>
                            <img 
                                data-src="${photo.url}"
                                alt="Photo de ${photo.name}"
                                loading="lazy"
                                class="absolute top-0 left-0 w-full h-full object-cover opacity-0 transition-opacity duration-500"
                                width="400"
                                height="600"
                            >
                        </div>
                        
                        <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/80 to-transparent p-6">
                            <div class="flex justify-between items-start flex-wrap gap-4">
                                <div class="flex-1 min-w-[200px]">
                                    <div class="flex items-center mb-3">
                                        <i class="fas fa-user text-gray-300 mr-3 text-lg"></i>
                                        <span class="font-semibold text-lg">${photo.name}</span>
                                    </div>
                                    <div class="flex items-center">
                                        <i class="fas fa-tag text-gray-300 mr-3 text-lg"></i>
                                        <span class="text-gray-300">${photo.theme}</span>
                                    </div>
                                </div>

                                <div class="flex-1 min-w-[200px]">
                                    <div class="flex items-center justify-end space-x-4 mb-3">
                                        <button class="like-btn flex items-center ${photo.liked ? 'liked' : 'bg-pink-600'} hover:bg-pink-700 px-4 py-2 rounded-full transition-all duration-300 transform hover:scale-105" 
                                                data-photo-id="${photo.id}">
                                            <i class="fas fa-heart text-white mr-2 ${photo.liked ? 'text-red-400' : ''}"></i>
                                            <span class="like-count text-white font-semibold">${photo.likes}</span>
                                        </button>
                                    </div>
                                    <button class="share-btn flex items-center justify-center bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-full transition-all duration-300 w-full transform hover:scale-105" 
                                            data-photo-id="${photo.id}">
                                        <i class="fas fa-share text-white mr-2"></i>
                                        <span class="text-white font-semibold">Partager</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </section>
                `).join('');
            }

            completeLoading() {
                this.loadingScreen.classList.add('fade-out');
                this.mainContainer.style.opacity = '1';
                
                setTimeout(() => {
                    this.initializeLazyLoading();
                    
                    if (this.targetPhotoId) {
                        this.scrollToTargetPhoto();
                    }
                    
                    // Charger l'état des likes après le rendu
                    window.photoApp.loadLikedState();
                    this.loadingScreen.remove();
                }, 800);
            }

            scrollToTargetPhoto() {
                setTimeout(() => {
                    const targetElement = document.getElementById(`photo-${this.targetPhotoId}`);
                    if (targetElement) {
                        targetElement.scrollIntoView({ behavior: 'smooth' });
                        
                        const photoIndex = photos.findIndex(p => p.id === this.targetPhotoId);
                        if (photoIndex !== -1) {
                            window.photoApp.currentPhotoIndex = photoIndex;
                        }
                    }
                }, 100);
            }

            initializeLazyLoading() {
                const imageObserver = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            const img = entry.target;
                            const placeholder = img.previousElementSibling;
                            
                            img.src = img.dataset.src;
                            img.removeAttribute('data-src');
                            
                            img.onload = () => {
                                img.style.opacity = '1';
                                if (placeholder) {
                                    placeholder.style.opacity = '0';
                                    setTimeout(() => {
                                        placeholder.style.display = 'none';
                                    }, 500);
                                }
                                window.soundManager.play('scroll');
                            };
                            
                            imageObserver.unobserve(img);
                        }
                    });
                }, { threshold: 0.1 });

                document.querySelectorAll('img[data-src]').forEach(img => {
                    imageObserver.observe(img);
                });
            }
        }

        // =============================================
        // APPLICATION PRINCIPALE
        // =============================================

        class PhotoApp {
            constructor() {
                this.currentPhotoIndex = 0;
                this.isScrolling = false;
                this.scrollTimeout = null;
                this.init();
            }

            init() {
                this.attachEventListeners();
                this.generateRanking();
            }

            attachEventListeners() {
                const mainContainer = document.getElementById('mainContainer');
                
                mainContainer.addEventListener('scroll', this.handleScroll.bind(this));
                
                document.addEventListener('click', (e) => {
                    if (e.target.closest('.like-btn')) {
                        e.preventDefault();
                        const photoId = parseInt(e.target.closest('.like-btn').dataset.photoId);
                        this.handleLike(photoId);
                        return;
                    }
                    
                    if (e.target.closest('.share-btn')) {
                        e.preventDefault();
                        const photoId = parseInt(e.target.closest('.share-btn').dataset.photoId);
                        this.handleShare(photoId);
                        return;
                    }
                });

                document.addEventListener('keydown', (e) => {
                    if (e.key === 'ArrowDown') {
                        this.scrollToPhoto(this.currentPhotoIndex + 1);
                    } else if (e.key === 'ArrowUp') {
                        this.scrollToPhoto(this.currentPhotoIndex - 1);
                    }
                });

                document.getElementById('rankingIcon').addEventListener('click', () => {
                    window.soundManager.play('scroll');
                    this.showRanking();
                });
                document.getElementById('closeModal').addEventListener('click', () => this.hideRanking());
                document.getElementById('closeModalBtn').addEventListener('click', () => this.hideRanking());
                
                this.setupTouchEvents();
            }

            async loadLikedState() {
                let userId = localStorage.getItem('anonymousUserId');
                if (!userId) return;

                const db = firebase.firestore();
                
                for (let photo of photos) {
                    try {
                        const userLikeRef = db.collection('photos').doc(photo.id.toString()).collection('likes').doc(userId);
                        const likeDoc = await userLikeRef.get();
                        
                        photo.liked = likeDoc.exists;
                        
                        const likeBtn = document.querySelector(`.like-btn[data-photo-id="${photo.id}"]`);
                        const heartIcon = likeBtn?.querySelector('i');
                        
                        if (likeBtn && heartIcon) {
                            if (photo.liked) {
                                likeBtn.classList.add('liked');
                                heartIcon.classList.add('text-red-400');
                            } else {
                                likeBtn.classList.remove('liked');
                                heartIcon.classList.remove('text-red-400');
                            }
                        }
                    } catch (error) {
                        console.error(`Erreur chargement like photo ${photo.id}:`, error);
                    }
                }
            }

            async handleLike(photoId) {
                let userId = localStorage.getItem('anonymousUserId');
                if (!userId) {
                    userId = 'anon_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    localStorage.setItem('anonymousUserId', userId);
                }

                const db = firebase.firestore();
                const photoRef = db.collection('photos').doc(photoId.toString());
                const userLikeRef = photoRef.collection('likes').doc(userId);

                try {
                    await db.runTransaction(async (transaction) => {
                        const userLikeDoc = await transaction.get(userLikeRef);
                        const photoDoc = await transaction.get(photoRef);
                        
                        if (!photoDoc.exists) {
                            throw new Error("La photo n'existe pas.");
                        }

                        const currentLikes = photoDoc.data().totalLikes || 0;

                        if (userLikeDoc.exists) {
                            // UNLIKE
                            transaction.delete(userLikeRef);
                            transaction.update(photoRef, {
                                totalLikes: currentLikes - 1
                            });
                        } else {
                            // LIKE
                            transaction.set(userLikeRef, {
                                timestamp: firebase.firestore.FieldValue.serverTimestamp()
                            });
                            transaction.update(photoRef, {
                                totalLikes: currentLikes + 1
                            });
                        }
                    });

                    // Recharger les données
                    await this.loadPhotoData(photoId);
                    await this.loadLikedState();
                    this.generateRanking();
                    window.soundManager.play('like');

                } catch (error) {
                    console.error("Erreur lors du like : ", error);
                }
            }

            async loadPhotoData(photoId) {
                try {
                    const db = firebase.firestore();
                    const docRef = db.collection('photos').doc(photoId.toString());
                    const doc = await docRef.get();
                    
                    if (doc.exists) {
                        const photo = photos.find(p => p.id === photoId);
                        if (photo) {
                            photo.likes = doc.data().totalLikes || 0;
                            
                            // Mettre à jour l'interface
                            const likeCount = document.querySelector(`.like-btn[data-photo-id="${photoId}"] .like-count`);
                            if (likeCount) {
                                likeCount.textContent = photo.likes;
                            }
                        }
                    }
                } catch (error) {
                    console.error('Erreur chargement photo:', error);
                }
            }

            handleScroll() {
                if (this.isScrolling) return;
                this.isScrolling = true;
                
                const scrollPosition = document.getElementById('mainContainer').scrollTop;
                const windowHeight = window.innerHeight;
                const newIndex = Math.round(scrollPosition / windowHeight);
                
                if (newIndex !== this.currentPhotoIndex && newIndex >= 0 && newIndex < photos.length) {
                    this.currentPhotoIndex = newIndex;
                    window.soundManager.play('scroll');
                    this.updateURL();
                }
                
                clearTimeout(this.scrollTimeout);
                this.scrollTimeout = setTimeout(() => {
                    this.isScrolling = false;
                }, 100);
            }

            scrollToPhoto(index) {
                if (index < 0 || index >= photos.length) return;
                this.currentPhotoIndex = index;
                const targetElement = document.getElementById(`photo-${photos[index].id}`);
                if (targetElement) {
                    targetElement.scrollIntoView({ behavior: 'smooth' });
                    window.soundManager.play('scroll');
                    this.updateURL();
                }
            }

            handleShare(photoId) {
                const photo = photos.find(p => p.id === photoId);
                if (!photo) return;
                
                window.soundManager.play('share');
                const shareUrl = `${window.location.origin}${window.location.pathname}?photo=${photoId}`;
                
                if (navigator.share) {
                    navigator.share({
                        title: `Photo de ${photo.name}`,
                        text: `Découvrez cette magnifique photo sur notre galerie! Thème: ${photo.theme}`,
                        url: shareUrl
                    });
                } else {
                    navigator.clipboard.writeText(shareUrl).then(() => {
                        alert('Lien copié dans le presse-papiers!');
                    });
                }
            }

            showRanking() {
                document.getElementById('rankingModal').classList.remove('hidden');
            }

            hideRanking() {
                document.getElementById('rankingModal').classList.add('hidden');
            }

            generateRanking() {
                const sortedPhotos = [...photos].sort((a, b) => b.likes - a.likes);
                const rankingList = document.getElementById('rankingList');
                
                rankingList.innerHTML = sortedPhotos.map((photo, index) => `
                    <div class="flex justify-between items-center py-3 px-4 bg-gray-700/50 rounded-lg transition-all duration-300 hover:bg-gray-700/70">
                        <div class="flex items-center">
                            <span class="font-bold text-yellow-400 mr-4 w-6 text-center">${index + 1}</span>
                            <div>
                                <div class="font-semibold">${photo.name}</div>
                                <div class="text-sm text-gray-400">${photo.theme}</div>
                            </div>
                        </div>
                        <div class="flex items-center text-pink-400 font-semibold">
                            <i class="fas fa-heart mr-2"></i>
                            <span>${photo.likes}</span>
                        </div>
                    </div>
                `).join('');
            }

            updateURL() {
                const currentPhoto = photos[this.currentPhotoIndex];
                const newURL = `${window.location.origin}${window.location.pathname}?photo=${currentPhoto.id}`;
                window.history.replaceState({}, '', newURL);
            }

            setupTouchEvents() {
                let touchStartY = 0;
                const container = document.getElementById('mainContainer');
                
                container.addEventListener('touchstart', e => {
                    touchStartY = e.changedTouches[0].screenY;
                }, { passive: true });
                
                container.addEventListener('touchend', e => {
                    const touchEndY = e.changedTouches[0].screenY;
                    const diff = touchStartY - touchEndY;
                    const swipeThreshold = 50;
                    
                    if (Math.abs(diff) > swipeThreshold) {
                        if (diff > 0) {
                            this.scrollToPhoto(this.currentPhotoIndex + 1);
                        } else {
                            this.scrollToPhoto(this.currentPhotoIndex - 1);
                        }
                    }
                }, { passive: true });
            }
        }

        // =============================================
        // INITIALISATION
        // =============================================

        window.soundManager = new SimpleSoundManager();

        document.addEventListener('DOMContentLoaded', () => {
            window.photoApp = new PhotoApp();
            
            const loadingManager = new LoadingManager();
            loadingManager.startLoading();
        });

        window.addEventListener('resize', () => {
            if (!window.photoApp) return;
            setTimeout(() => {
                const scrollPosition = document.getElementById('mainContainer').scrollTop;
                const windowHeight = window.innerHeight;
                window.photoApp.currentPhotoIndex = Math.round(scrollPosition / windowHeight);
            }, 100);
        });
    </script>
</body>
</html>